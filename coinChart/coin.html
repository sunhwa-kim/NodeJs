<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>김선화_Z 코인줌</title>
</head>

<body>
  <style>
    .todaycoin {
      display: inline;
      width:13%;
      float:left;
    }

  </style>
  <div><h4 id='dateInfo'></h4></div>
  <div id="todayCoin"></div>
  <span id="spreadInfo"></span><br>
  <span id="showGraph"></span>
  <div id="chart_div"></div>
  <input type="button" name="" value="그래프" id="graphBtn">
  <input type="button" name="" value="엑셀 다운받기" id="reqHtml"></br>

</body>
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
// var pk_name = Array(6).fill(null).map(() => Array());
var pk_name = []
var reqParamList = [];
  $.ajax({
    url: `/reqInfo`,
    type: 'get',
    success: function(res) {
      var dateInfo = new Date();
      $('#dateInfo').append(' * '+dateInfo)

      for(var i=0; i<res.length;i++){
        var reqParam = {};
        for (var j=0; j<res[i].length;j++){
          if (res[i][j] != ""){
            $('#todayCoin').append('<div class="todaycoin">'+res[i][j]+'</div>')
              if (j==0) {
                reqParam.coinName = res[i][j].trim();
              }
              else {
                res_check = true;
                data = []
                data = res[i][j].slice(0,-2).split('(');
                data[0] = data[0].replace(/,/gi,"")
                if (j==1){
                  reqParam.upbit = Number(data[0]);
                  reqParam.upbitFluctuation = Number(data[1].slice(1));
                }
                else if(j==2){
                  reqParam.bitfinex = Number(data[0])
                  reqParam.bitfinexFluctuation = Number(data[1].slice(1));
                }
              }  // end of else
          }
        } // end of for with j
        $('#todayCoin').append(`<input type="button"  onclick="saveCoinData('${reqParam.coinName}')" value="저장"></br>`)
        reqParamList.push(reqParam);
    } //  end of for

      $.ajax({
        url:'/selectCoinName',
        type:'post',
        data:{
          param : JSON.stringify(reqParamList)
        },success:function(res){
          for (var i=0 ; i < res.length ; i++){
            pk_name.push([res[i].idx_pk,res[i].coinName])
          }
        }
      });      //  end of select coin_pk table

  }});



function saveCoinData(coinNm){
  var reqParam = {}
  for (var i=0 ; i<5; i++){
    if ( pk_name[i][1] == coinNm){
      reqParam.coin_pk = pk_name[i][0]
      reqParam.upbit = reqParamList[i].upbit
      reqParam.upbitFluctuation = reqParamList[i].upbitFluctuation
      reqParam.bitfinex = reqParamList[i].bitfinex
      reqParam.bitfinexFluctuation = reqParamList[i].bitfinexFluctuation
    }
  }   //  end of for

  $.ajax({
    url:'/insertCoin',
    type:'post',
    data:{
      param : JSON.stringify(reqParam)
    },success:function(res){
      alert('저장 완료 됐습니다.')
      alert(res)
    }
  });      //  end of select coin_pk table
}



        var dailyAverage = [];
  $("#graphBtn").click(function() {
//  평균 로직은 데이터 모인 후에  -dailyAverage 채우기
            console.log(reqParamList)
            var arrForCahrt = [];
            var avg = 0;
            for (var i =0; i < reqParamList.length ; i++ ){
              arrForCahrt.push([reqParamList[i].coinName, reqParamList[i].upbit,reqParamList[i].upbitFluctuation])
            }

            google.charts.load('current', {packages: ['corechart', 'line']});
            google.charts.setOnLoadCallback(drawBasic);
            function drawBasic() {

                  var data = new google.visualization.DataTable();
                  data.addColumn('string', '코인명');    //  ?
                  data.addColumn('number', 'upbit');
                  data.addColumn('number', '변동률');

                  data.addRows( arrForCahrt );

                  var options = {
                    hAxis: {
                      title: '코인명'
                    },
                    vAxis: {
                      title: 'upbit'
                    }
                  };

                  var chart = new google.visualization.LineChart(document.getElementById('chart_div'));

                  chart.draw(data, options);
                }

      });

</script>

</html>
